{{- define "main" -}}
  {{- $lang := .Site.Language.Lang -}}
  {{- $proj := (index site.Data $lang "projects" "projects") | default (index site.Data "us" "projects" "projects") -}}

  {{/* UI-строки */}}
  {{- $title    := or $proj.title (partial "t.html" (dict "key" "ui.projects.title"    "ctx" .)) -}}
  {{- $tocTitle :=                (partial "t.html" (dict "key" "ui.projects.tocTitle" "ctx" .)) -}}
  {{- $viewTxt  :=                (partial "t.html" (dict "key" "ui.common.view"       "ctx" .)) -}}
  {{- $ctaLbl   :=                (partial "t.html" (dict "key" "ui.cta.contact"       "ctx" .)) -}}

  <section class="projects-page">
    <!-- HERO -->
    <section class="hero">
      <h1>{{ $title }}</h1>
      {{ with $proj.intro }}<p class="tagline">{{ . }}</p>{{ end }}
      {{ with $proj.highlights }}
        <ul class="sub">
          {{ range . }}<li>{{ . }}</li>{{ end }}
        </ul>
      {{ end }}
    </section>

    <div class="services-layout">
      <!-- Overview (левый сайдбар) -->
      {{ partial "toc.html" (dict "title" $tocTitle "items" $proj.sections) }}

      <!-- Контент -->
      <div class="services-content">
        {{ range $proj.sections }}
          {{- $sid := .id -}}
          <section {{ if $sid }}id="{{ $sid }}"{{ end }} class="service-block card spy-section">
            <h2>{{ .title }}</h2>

            {{ with .text }}
              {{ $paras := split . "\n\n" }}
              {{ range $paras }}<p>{{ . | markdownify }}</p>{{ end }}
            {{ end }}

            {{ with .items }}
              <div class="grid">
                {{ range . }}
                  {{- $title := .title -}}
                  {{- $desc  := .desc  -}}
                  {{- $href  := .href  -}}   {{/* страница/детали */}}
                  {{- $repo  := .repo  -}}   {{/* GitHub */}}
                  {{- $icon  := .icon  -}}
                  {{- $badge := .badge -}}
                  <article class="card">
                    {{ if $badge }}<p class="sub">{{ $badge }}</p>{{ end }}
                    <h3>
                      {{ if $href }}
                        <a href="{{ $href }}">
                          {{ if $icon }}<span>{{ $icon }}</span>{{ end }}{{ $title }}
                        </a>
                      {{ else }}
                        {{ if $icon }}<span>{{ $icon }}</span>{{ end }}{{ $title }}
                      {{ end }}
                    </h3>
                    {{ with $desc }}<p>{{ . }}</p>{{ end }}

                    <div class="cta-row">
                      {{ if $href }}
                        <a class="btn tertiary" href="{{ $href }}">{{ $viewTxt }}</a>
                      {{ end }}
                      {{ if $repo }}
                        <a class="btn secondary" href="{{ $repo }}">GitHub</a>
                      {{ end }}
                    </div>
                  </article>
                {{ end }}
              </div>
            {{ end }}

            {{ with .cta }}
              {{- $raw := .href | default "contacts" -}}
              {{- $href := cond (hasPrefix $raw "http") $raw ((printf "/%s/" (trim $raw "/")) | relLangURL) -}}
              <p><a class="btn" href="{{ $href }}">{{ or .text $ctaLbl }}</a></p>
            {{ end }}
          </section>
        {{ end }}

        {{ with $proj.cta }}
          {{- $raw  := .href | default "contacts" -}}
          {{- $href := cond (hasPrefix $raw "http") $raw ((printf "/%s/" (trim $raw "/")) | relLangURL) -}}
          <section class="service-cta-final card" style="text-align:center">
            <h2>{{ .title }}</h2>
            {{ with .text }}<p class="sub">{{ . }}</p>{{ end }}
            <a class="btn" href="{{ $href }}">{{ or .button $ctaLbl }}</a>
          </section>
        {{ end }}
      </div>
    </div>
  </section>
{{- end -}}
