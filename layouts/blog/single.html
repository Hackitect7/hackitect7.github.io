{{- define "main" -}}
  {{- $minRead  := partial "t.html" (dict "key" "ui.blog.minRead"    "ctx" . "default" "min read") -}}
  {{- $more     := partial "t.html" (dict "key" "ui.blog.more"       "ctx" . "default" "More from the blog") -}}
  {{- $backTo   := partial "t.html" (dict "key" "ui.blog.backToList" "ctx" . "default" "Back to blog") -}}
  {{- $ariaPrev := partial "t.html" (dict "key" "ui.aria.prevPost"   "ctx" . "default" "Previous post") -}}
  {{- $ariaNext := partial "t.html" (dict "key" "ui.aria.nextPost"   "ctx" . "default" "Next post") -}}
  {{- $dateFmt  := printf "%s" (partial "t.html" (dict "key" "ui.blog.dateFormat" "ctx" . "default" "Jan 02, 2006")) -}}
  {{- $dateISO  := .Date.Format "2006-01-02T15:04:05Z07:00" -}}

  {{/* Обложка и альтернативы */}}
  {{- $cover        := .Params.cover -}}
  {{- $coverAlt     := .Params.coverAlt | default .Title -}}
  {{- $coverCaption := .Params.coverCaption | default "" -}}
  {{- $featured     := .Params.featuredImage | default .Params.ogImage -}}

  <section class="blog-page">
    <!-- HERO -->
    <section class="hero section">
      <h1>{{ .Title }}</h1>
      <p class="sub">
        <time datetime="{{ $dateISO }}">{{ .Date.Format $dateFmt }}</time>
        {{- with .ReadingTime -}} · {{ . }} {{ $minRead }}{{- end -}}
        {{- with .Params.categories -}} · {{ delimit . ", " }}{{- end -}}
        {{- if gt (sub (time.Now.Unix) (.Lastmod.Unix)) 0 -}}
          {{- if ne (.Lastmod.Format "2006-01-02") (.Date.Format "2006-01-02") -}}
            · <span aria-label="Updated on">{{ partial "t.html" (dict "key" "ui.blog.updated" "ctx" . "default" "Updated") }} {{ .Lastmod.Format $dateFmt }}</span>
          {{- end -}}
        {{- end -}}
      </p>
    </section>

    {{/* Обложка: выводим только если cover задан.
        featuredImage остаётся для OG/SEO (head.partial уже берёт его), на страницу не выводим. */}}
    {{- with $cover -}}
      <figure class="section card" style="padding:0; overflow:hidden">
        <img src="{{ . | relURL }}"
             alt="{{ $coverAlt }}"
             style="display:block; width:100%; height:auto"
             loading="lazy" decoding="async" />
        {{- with $coverCaption -}}
          <figcaption class="sub" style="padding:8px 12px">{{ . | markdownify }}</figcaption>
        {{- end -}}
      </figure>
    {{- end -}}

    <!-- CONTENT -->
    <article class="section card">
      {{ .Content }}

      {{- with .Params.tags -}}
        <p class="sub" style="margin-top:12px" aria-label="Tags">
          {{- $links := slice -}}
          {{- range . -}}
            {{- $slug := urlize . -}}
            {{- $href := (printf "/tags/%s/" $slug) | relLangURL -}}
            {{- $links = $links | append (printf `<a href="%s" rel="tag">#%s</a>` $href .) -}}
          {{- end -}}
          {{- delimit $links ", " | safeHTML -}}
        </p>
      {{- end -}}

      {{- with .Params.categories -}}
        <p class="sub" style="margin-top:6px" aria-label="Categories">
          {{- $links := slice -}}
          {{- range . -}}
            {{- $slug := urlize . -}}
            {{- $href := (printf "/categories/%s/" $slug) | relLangURL -}}
            {{- $links = $links | append (printf `<a href="%s" rel="category">%s</a>` $href .) -}}
          {{- end -}}
          {{- delimit $links ", " | safeHTML -}}
        </p>
      {{- end -}}
    </article>

    <!-- NAV -->
    <section class="section">
      <nav class="cta-row" aria-label="Post navigation">
        {{- if .PrevInSection -}}
          <a class="btn secondary" href="{{ .PrevInSection.RelPermalink }}" rel="prev" aria-label="{{ $ariaPrev }}">← {{ .PrevInSection.Title }}</a>
        {{- else -}}<span></span>{{- end -}}
        {{- if .NextInSection -}}
          <a class="btn secondary" href="{{ .NextInSection.RelPermalink }}" rel="next" aria-label="{{ $ariaNext }}">{{ .NextInSection.Title }} →</a>
        {{- else -}}<span></span>{{- end -}}
      </nav>
    </section>

    <!-- CTA -->
    <section class="section card service-cta-final">
      <h2>{{ $more }}</h2>
      <a class="btn" href="{{ "/blog/" | relLangURL }}">{{ $backTo }}</a>
    </section>
  </section>
{{- end -}}
