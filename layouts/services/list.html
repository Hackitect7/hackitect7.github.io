{{ define "main" }}
  {{- $lang := .Site.Language.Lang -}}

  {{/* locales/<lang>/services.yaml -> корень services: */}}
  {{- $svcRoot := (index site.Data $lang "services") | default (index site.Data "us" "services") -}}
  {{- $svc     := (index $svcRoot "services") | default dict -}}

  {{/* Лейблы через t.html (важно: ctx = $, чтобы не ломался контекст) */}}
  {{- $title    := or $svc.title (partial "t.html" (dict "key" "ui.services.title"    "ctx" $ "default" "Services")) -}}
  {{- $tocTitle :=      partial "t.html" (dict "key" "ui.services.tocTitle" "ctx" $ "default" "Overview") -}}
  {{- $ctaText  :=      partial "t.html" (dict "key" "ui.cta.contact"      "ctx" $ "default" "Contact me") -}}

  {{- $ctaBase := .Site.Params.ctaBase | default (printf "/%s/contacts/?utm_source=services&utm_medium=site&utm_campaign=" $lang) -}}
  {{- $ctaBase = replace $ctaBase "/us/" (print "/" $lang "/") -}}

  <!-- HERO -->
  <section class="hero section" role="region" aria-label="Services hero">
    <h1>{{ $title }}</h1>
    {{ with $svc.intro }}<p class="tagline">{{ . }}</p>{{ end }}
  </section>

  <div class="services-layout section">
    <!-- TOC -->
    {{- $sections := $svc.sections | default (slice) -}}
    {{ partial "toc.html" (dict "title" $tocTitle "items" $sections) }}

    <!-- Content -->
    <div class="services-content">
      {{- $itemsForLD := slice -}}
      {{- range $idx, $s := $sections -}}
        {{- $id    := $s.id    | default "" -}}
        {{- $stitle := $s.title | default "" -}}
        {{- if and $id $stitle -}}
          {{- $hid := printf "%s-h2" $id -}}
          <section id="{{ $id }}" class="service-block section card spy-section" aria-labelledby="{{ $hid }}">
            <h2 id="{{ $hid }}">{{ $stitle }}</h2>

            {{ with $s.text }}
              <div class="service-text">{{ . | markdownify }}</div>
            {{ end }}

            {{ with $s.bullets }}
              {{ if gt (len .) 0 }}
                <ul class="bullets">
                  {{ range . }}<li>{{ . }}</li>{{ end }}
                </ul>
              {{ end }}
            {{ end }}

            {{ with $s.cta }}
              {{- $raw := .href | default "contacts" -}}
              {{- $campaign := .utmCampaign | default $id -}}
              {{- $href := cond (hasPrefix $raw "http") $raw (printf "%s%s" $ctaBase (urlize $campaign)) -}}
              {{- if $href -}}
                <p>
                  <a class="btn"
                     href="{{ $href }}"
                     rel="noopener"
                     data-analytics="svc-cta-{{ $campaign }}"
                     aria-label="{{ printf "Open contacts for '%s'" $stitle }}">
                    {{ .text | default $ctaText }}
                  </a>
                </p>
              {{- end -}}
            {{ end }}
          </section>

          {{/* Собираем данные для JSON-LD ItemList (важно: $.Permalink) */}}
          {{- $itemsForLD = $itemsForLD | append (dict
              "@type" "ListItem"
              "position" (add $idx 1)
              "name" $stitle
              "url" (printf "%s#%s" $.Permalink $id)
            ) -}}
        {{- end -}}
      {{- end -}}

      <!-- Финальный CTA -->
      {{ with $svc.finalCta }}
        {{- $campaign := .utmCampaign | default "services-final" -}}
        {{- $raw := .href | default "contacts" -}}
        {{- $href := cond (hasPrefix $raw "http") $raw (printf "%s%s" $ctaBase (urlize $campaign)) -}}
        <section class="section card service-cta-final" style="text-align:center" aria-labelledby="services-final-h2">
          <h2 id="services-final-h2">{{ .title | default "Ready to talk?" }}</h2>
          {{ with .text }}<p class="sub">{{ . }}</p>{{ end }}
          {{ if $href }}
            <a class="btn"
               href="{{ $href }}"
               rel="noopener"
               data-analytics="svc-cta-{{ $campaign }}">
               {{ .contact | default $ctaText }}
            </a>
          {{ end }}
        </section>
      {{ end }}

      {{/* JSON-LD ItemList для списка услуг */}}
      {{ if gt (len $itemsForLD) 0 }}
        <script type="application/ld+json">
          {{ dict
            "@context" "https://schema.org"
            "@type" "ItemList"
            "itemListElement" $itemsForLD
          | jsonify }}
        </script>
      {{ end }}
    </div>
  </div>
{{ end }}
