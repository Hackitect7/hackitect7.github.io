{{- define "main" -}}
  <section class="projects-page">
    {{- $lang := .Site.Language.Lang -}}
    {{- $proj := (index site.Data $lang "projects") | default (index site.Data "us" "projects") -}}
    {{- $ui   := (index site.Data $lang "ui")       | default (index site.Data "us" "ui") -}}

    {{/* HERO */}}
    <section class="hero">
      <h1>{{ or $proj.title (or $ui.projects.title "Projects") }}</h1>
      {{- with $proj.intro -}}<p class="tagline">{{ . }}</p>{{- end -}}
      {{- with $proj.highlights -}}
        <ul class="sub">
          {{- range . -}}<li>{{ . }}</li>{{- end -}}
        </ul>
      {{- end -}}
    </section>

    <div class="services-layout">
      {{- /* Универсальный TOC слева */ -}}
      {{- partial "toc.html" (dict "title" (or $ui.projects.tocTitle "Overview") "items" $proj.sections) -}}

      {{- /* Контент справа */ -}}
      <div class="services-content">
        {{- range $proj.sections -}}
          {{- $sid := .id -}}
          <section
            {{ if $sid }}id="{{ $sid }}"{{ end }}
            class="service-block card spy-section"
          >
            <h2>{{ .title }}</h2>

            {{- with .text -}}
              {{- $paras := split . "\n\n" -}}
              {{- range $paras -}}<p>{{ . | markdownify }}</p>{{- end -}}
            {{- end -}}


            <div class="grid">
              {{- range .items -}}
                {{- $title := index . "title" -}}
                {{- $desc  := index . "desc" -}}
                {{- $href  := index . "href" -}}
                {{/* детальная / демо */}}
                {{- $repo  := index . "repo" -}}
                {{/* GitHub / код */}}
                {{- $icon  := index . "icon" -}}
                {{- $badge := index . "badge" -}}


                <article class="card">
                  {{- if $badge -}}<p class="sub">{{ $badge }}</p>{{- end -}}
                  <h3>
                    {{- if $href -}}
                      <a href="{{ $href }}"
                        >{{ if $icon }}
                          <span>{{ $icon }}</span>
                        {{ end }}{{ $title }}</a
                      >
                    {{- else -}}
                      {{ if $icon }}
                        <span>{{ $icon }}</span>
                      {{ end }}{{ $title }}
                    {{- end -}}
                  </h3>
                  {{- with $desc -}}<p>{{ . }}</p>{{- end -}}


                  <div class="cta-row">
                    {{- if $href -}}
                      <a class="btn tertiary" href="{{ $href }}"
                        >{{ or $ui.common.view "View" }}</a
                      >
                    {{- end -}}
                    {{- if $repo -}}
                      <a class="btn secondary" href="{{ $repo }}">GitHub</a>
                    {{- end -}}
                  </div>
                </article>
              {{- end -}}
            </div>
          </section>
        {{- end -}}

        {{- /* Финальный CTA */ -}}
        {{- with $proj.cta -}}
          {{- $raw  := .href | default "contacts" -}}
          {{- $href := cond (hasPrefix $raw "http") $raw ((printf "/%s/%s/" $lang (trim $raw "/")) | relLangURL) -}}
          <section class="service-cta-final card" style="text-align:center">
            <h2>{{ .title }}</h2>
            {{- with .text -}}<p class="sub">{{ . }}</p>{{- end -}}
            <a class="btn" href="{{ $href }}"
              >{{ or .button (or $ui.cta.contact "Contact me") }}</a
            >
          </section>
        {{- end -}}
      </div>
    </div>
  </section>
{{- end -}}
